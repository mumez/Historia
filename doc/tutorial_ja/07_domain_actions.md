# モデルスペースへのドメインアクションの定義

## ドメインアクションを追加する理由

ModelSpace はモデルを管理するための汎用的なメカニズムを提供しますが、ドメイン固有のアクションを追加することで、ビジネスロジックをカプセル化し、モデルとの対話のための明確な API を提供することが容易になります。これらのアクションを定義することで、以下のことが可能になります：

- 一般的な操作（例：残高の取得）を簡素化する
- ビジネスロジックを一元化することで一貫性を確保する
- コードの可読性と保守性を向上させる

## 実装するアクション

`HtBankAccountSpace`に以下のアクションを実装します：

1. **残高の取得**: 特定の口座の現在の残高を取得する
2. **入金**: 指定された金額を口座の残高に追加する
3. **出金**: 指定された金額を口座の残高から減算する

### 残高の取得

特定の口座の残高を取得するために、`getBalanceAt:`メソッドを定義します。このメソッドは口座 ID を入力として受け取り、ModelSpace から対応するモデルを取得し、その残高を返します。

```Smalltalk
(actions)
getBalanceAt: accountId
    | acc |
    acc := self modelAt: accountId.
    ^ acc balance
```

#### 説明：

1. **モデルの取得**: `modelAt:`メソッドは、指定された`accountId`に関連付けられたモデルインスタンスを取得します。
2. **残高へのアクセス**: モデルの`balance`属性が返されます。

### 入金

口座に入金するために、`deposit:at:`メソッドを定義します。このメソッドは口座モデルを取得し、残高変更イベントを追加し、更新されたモデルを保存します。

```Smalltalk
(actions)
deposit: amount at: accountId
    | acc |
    acc := self modelAt: accountId.
    acc mutateBalanceChange: amount.
    self save: acc
```

#### 説明：

1. **モデルの取得**: `modelAt:`メソッドは口座モデルを取得します。
2. **残高変更による変更**: `mutateBalanceChange:`メソッドは入金をイベントとして記録します。
3. **モデルの保存**: `save:`メソッドは更新されたモデルとそのイベントをリポジトリに永続化します。

### 出金

口座から出金するために、`withdraw:at:`メソッドを定義します。このメソッドは入金メソッドと似ていますが、出金を表すために負の残高変更を追加します。

```Smalltalk
(actions)
withdraw: amount at: accountId
    | acc |
    acc := self modelAt: accountId.
    acc mutateBalanceChange: amount negated.
    self save: acc
```

#### 説明：

1. **モデルの取得**: `modelAt:`メソッドは口座モデルを取得します。
2. **負の残高変更による変更**: `mutateBalanceChange:`メソッドは金額を負にすることで出金をイベントとして記録します。
3. **モデルの保存**: `save:`メソッドは更新されたモデルとそのイベントをリポジトリに永続化します。

### 重要な注意点

1. **イベントの永続化**: `save:`メソッドは、保留中のイベント（この場合は`HtBankAccountBalanceChanged`インスタンス）が基盤となるリポジトリに保存されることを保証します。これにより、フレームワークはイベントを再生し、任意の時点でのモデルの状態を復元することができます。
2. **一貫性**: 入金と出金のロジックを ModelSpace に一元化することで、すべての操作が一貫しており、同じルールに従うことを保証します。
3. **エラー処理**: 実際のアプリケーションでは、出金時の残高不足などの条件をチェックするエラー処理を追加する必要があります。

以下は、これらのアクションを組み合わせて使用する例です：

```Smalltalk
"ステップ1: 口座に入金する"
modelSpace deposit: 100 at: accId.

"ステップ2: 口座から出金する"
modelSpace withdraw: 30 at: accId.

"ステップ3: 現在の残高を取得する"
modelSpace getBalanceAt: accId. "-> 70"
```
